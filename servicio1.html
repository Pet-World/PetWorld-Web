<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="styleServ1.css">
    <link rel="stylesheet" href="styleSoliServicios.css">
    <link rel="stylesheet" href="estilos.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>servicio1</title>
</head>

<body>
    <header id="header">

        <nav class="navegacion" id="nav-menu-container">
            <div id="contenedor_logo">
                <img id="logo_img" src="img/logo.png" alt="logo" onclick="window.location.href='/PetWorld-Web/index.html'">

                <ul class="nav-menu">
                    <li><a href="index.html#hero">INICIO</a></li>
                    <li><a href="index.html#conocenos">CONÓCENOS</a></li>
                    <li><a href="index.html#servicios">SERVICIOS</a></li>
                    <li><a href="index.html#contact">CONTÁCTANOS</a></li>
                </ul>
            </div>
            <button id="btn_inisesion" onclick="changeState()">INICIAR
                SESION</button>
        </nav>

    </header>
    <section id="noh">
        <rect></rect>
        <h1>Medicina Preventiva</h1>
        <img class="bone" src="img/bone.png"></img>
        <img class="med" src="img/med.png"></img>

        <img class="bp" src="img/bckp.png"></img>
        <img class="pet" src="img/pets1.png"></img>

        <t1>TOME EN CUENTA ACERCA DE</t1>
        <t2>LA CONSULTA VETERINARIA</t2>
        <tServ>
            <t3>CONOZCA NUESTROS</t3>
            <t4>EXÁMENES PREVENTIVOS</t4>
            <img class="tab" src="img/tabla.png"></img>
        </tServ>


        <p class="pr"> Para llevar a su mascota a una consulta médica veterinaria, tiene que estar registrado en la plataforma web, reservar los servicios que desee y nosotros le llamaremos para confirmar la fecha y hora disponible para su cita.
            <br><br> Recuerde que nuestro horario de atención de consultas inicia a las 09am. y culmina a las 20hrs. Siendo la última cita a las 19:30hrs.
            <br><br> Para que la atención de su mascota se desarrolle con tranquilidad y excelencia, le recomendamos asistir puntualmente al consultorio.
            <br><br> En caso de no poder asistir a la consulta, lo recomendable es comunicarse a nuestra Central de Citas, llamando al 01 223-2180 y reprogramar la fecha y hora de su consulta.
        </p>
        <r2 data-toggle="modal" data-target="#myModal"></r2>
        <bt data-toggle="modal" data-target="#myModal" onclick="solicitar()" id="btnSolicitar">SOLICITAR</bt>
        <!-- <button data-toggle="modal" data-target="#myModal">SOLICITAR</button> -->
        <g22>
            <hr class="lis" style="top: 49px;">
            <hr class="lis" style="top: 98px;">
            <hr class="lis" style="top: 147px;">
            <hr class="lis" style="top: 196px;">
            <hr class="lis" style="top: 247px;">
            <hr class="lis" style="top: 296px;">
            <img class="trv" src="img/triv.png" style="top: 18px;"></img>
            <img class="trv" src="img/triv.png" style="top: 67px;"></img>
            <img class="trv" src="img/triv.png" style="top: 116px;"></img>
            <img class="trv" src="img/triv.png" style="top: 165px;"></img>
            <img class="trv" src="img/triv.png" style="top: 214px;"></img>
            <img class="trv" src="img/triv.png" style="top: 263px;"></img>
            <img class="trv" src="img/triv.png" style="top: 312px;"></img>
            <lista>Chequeos médicos preventivos<br> Análisis de laboratorio<br> Ecografías
                <br> Microchips
                <br> Snaps de descarte de Parvovirosis<br> Snaps de descarte de distemper <br> Snaps de descarte de Sida
            </lista>

            <r3></r3>

        </g22>
        <g23>
            <recnt><input type="checkbox" id="cbox1" value="1_cb"></recnt>
            <recnt style="top: 50px;"><input type="checkbox" id="cbox2" value="2_cb"></recnt>
            <recnt style="top: 96px;"> <input type="checkbox" id="cbox3" value="3_cb"></recnt>
            <recnt style="top: 146px;"><input type="checkbox" id="cbox4" value="4_cb"></recnt>
            <recnt style="top: 195px;"><input type="checkbox" id="cbox5" value="5_cb"></recnt>
            <recnt style="top: 245px;"><input type="checkbox" id="cbox6" value="6_cb"></recnt>
            <recnt style="top: 295px;"><input type="checkbox" id="cbox7" value="7_cb"></recnt>
        </g23>


        <div class="modal fade" id="myModal" role="dialog">
            <div id="contenedor-boleta" class="modal-content">
                <div id="fila">
                    <h2 id="titulo-boleta">Solicitud de Servicio</h2>
                    <button id="exit" data-dismiss="modal"><img src="img/exit.png" alt=""></button>
                </div>
                <div class="columna1">
                    <div class="columna1" id="col1">
                        <fieldset>
                            <legend>Nombre(s)</legend>
                            <input readonly onmousedown="return false;" type="text" name="nombre" id="nombre">
                        </fieldset>
                        <fieldset>
                            <legend>DNI</legend>
                            <input readonly onmousedown="return false;" type="text" name="dni" id="dni">
                        </fieldset>
                        <fieldset>
                            <legend>Telefono Movil</legend>
                            <input readonly onmousedown="return false;" type="text" name="movil" id="movil">
                        </fieldset>
                    </div>
                    <div class="columna2" id="col2">

                        <fieldset>
                            <legend>Apellido(s)</legend>
                            <input readonly onmousedown="return false;" type="text" name="apellidos" id="apellidos">
                        </fieldset>

                        <fieldset id="cuadro_mascota">
                            <legend>Mascota</legend>
                            <select id="sel_mascota_nombre" multiple class="form-control">
                            </select>
                        </fieldset>

                    </div>
                    <fieldset class="cuadro-inline" id="cuadro-email">
                        <legend>E-mail</legend>
                        <input readonly onmousedown="return false;" type="text" name="email" id="email">
                    </fieldset>
                    <fieldset class="cuadro-inline">
                        <legend>Sugerencia de fecha para la cita</legend>
                        <input type="date" name="trip-start" value="2002-03-30" min="2018-01-01" max="2018-12-31" id="sugerencia">
                    </fieldset>
                </div>
                <div class="columna2">
                    <fieldset id="cuadro_resumen">
                        <legend>Resumen de solicitud de compra</legend>
                        <div id="resumen">

                        </div>
                    </fieldset>
                    <div class="text-input">
                        <input readonly onmousedown="return false;" type="text" name="total" id="total">
                        <h3>Total (S/.):</h3>
                    </div>
                </div>
                <p id="importante"><span>IMPORTANTE : </span>Tomar en cuenta las condiciones y pasos para la solicitud, movilidad y pago de un servicio</p>
                <button id="enviar" data-dismiss="modal" onclick="enviar()">ENVIAR</button>
            </div>
        </div>
    </section>
    <script>
        var UrlBackendJS = "http://localhost:5000";
        let mascotas = [];
        let id_servicios_seleccionados = [];

        var btnSession = document.getElementById("btn_inisesion");
        var btnSolicitar = document.getElementById("btnSolicitar");
        var sel_mascota_nombre = document.getElementById("sel_mascota_nombre");
        var resumen = document.getElementById("resumen");

        var nombre = document.getElementById("nombre");
        var apellidos = document.getElementById("apellidos");
        var movil = document.getElementById("movil");
        var dni = document.getElementById("dni");
        var email = document.getElementById("email");
        var total = document.getElementById("total");
        var sugerencia = document.getElementById("sugerencia");

        var userCurrent = localStorage.getItem("user") == "" ? "" : JSON.parse(localStorage.getItem("user"));
        if (userCurrent) {
            btnSession.innerHTML = "IR A PERFIL";
        } else {
            btnSession.innerHTML = "INICIAR SESIÓN";
        }

        function changeState() {
            if (btnSession.innerHTML == 'IR A PERFIL') {
                window.location.href = '/PetWorld-Web/perfil.html';
            } else {
                window.location.href = '/PetWorld-Web/inicioSesion.html';
            }
        }

        function solicitar() {
            if (userCurrent == "") {
                alert("Inicie sesión!");
                window.location.href = '/PetWorld-Web/inicioSesion.html';
                nombre.value = "";
                apellidos.value = "";
                email.value = "";
                dni.value = "";
                movil.value = "";
            } else {
                nombre.value = userCurrent.nombres;
                apellidos.value = userCurrent.apellidos;
                email.value = userCurrent.email;
                dni.value = userCurrent.dni;
                movil.value = userCurrent.celular;

                for (let index = 0; index < 7; index++) {
                    let cbx = document.getElementById(`cbox${index + 1}`);
                    // el 100 varia de acuerdo al tipo de servicio
                    let id_service_current = 100 + index;
                    if (cbx.checked) {
                        id_servicios_seleccionados.push(id_service_current);
                    }
                }

                // obtenemos las mascotas de acuerdo al dni del usuario
                getData(UrlBackendJS + `/pet/getPetsByDni?dni=${dni.value}`).then(response => {
                        let data = response.data;
                        for (let index = 0; index < data.length; index++) {
                            const element = data[index];
                            mascotas.push([element.nombre, element.id_mascota]);
                        }
                        for (let i = 0; i < mascotas.length; i++) {
                            let option = document.createElement("option");
                            option.text = mascotas[i][0];
                            sel_mascota_nombre.appendChild(option);
                        }
                        sel_mascota_nombre.selectedIndex = 0;
                    })
                    .catch((error) => {
                        console.log(error);
                        console.log("ocurrio un error");
                    });

                // eliminamos los hijos antes existentes de div 'resumen'
                let len = resumen.childElementCount;
                let child = resumen.lastElementChild;
                while (child && len >= 1) {
                    resumen.removeChild(child);
                    len -= 1;
                    child = resumen.lastElementChild;
                }

                // obtenemos informacion acerca de los servicios seleccionados
                var precioTotal = 0;
                id_servicios_seleccionados.forEach(id_service => {
                    getData(UrlBackendJS + `/service/getService?id_servicio=${id_service}`).then(response => {
                            let data = response.data[0];
                            let div = document.createElement("div");
                            let h5_nombre_servicio = document.createElement("h5");
                            let h6_precio_servicio = document.createElement("h6");

                            div.style = "display:flex; text-align: right; align-items:center;";
                            h5_nombre_servicio.style = "width: 450px";
                            h6_precio_servicio.style = "width: 100px";
                            h5_nombre_servicio.innerHTML = data.especificacion;
                            h6_precio_servicio.innerHTML = data.precio;

                            div.appendChild(h5_nombre_servicio);
                            div.appendChild(h6_precio_servicio);
                            resumen.appendChild(div);

                            precioTotal += data.precio;
                            total.value = String(parseFloat(precioTotal));
                        })
                        .catch((error) => {
                            console.log(error)
                            console.log("ocurrio un error")
                        });
                });
            }

        }

        function enviar() {
            let index_mascota_seleccionada = sel_mascota_nombre.selectedIndex;
            for (let index = 0; index < id_servicios_seleccionados.length; index++) {
                const id_mascota = mascotas[index_mascota_seleccionada][1];
                const id_servicio = id_servicios_seleccionados[index];

                let id_historial = parseInt(String(id_mascota) + String(id_servicio) + String(sugerencia.value.replace(/-/g, '')));

                let payload_historial_cita = {
                    id_historial,
                    dni: dni.value,
                    fecha: sugerencia.value,
                    id_servicio,
                    id_mascota,
                    valoracion: 0
                }
                postData(UrlBackendJS + '/historycite/createHistorycite', payload_historial_cita)
                    .then(data => {
                        if (data.status == 'SUCCESS') {
                            console.log(`Servicio con ID ${id_servicio} almacenado en el historial de citas`);
                        } else {
                            alert(data.message);
                        }
                    })
                    .catch((error) => {
                        console.log(error)
                    });
            }
        }


        async function postData(url = '', data) {
            const response = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Credentials': 'true'
                },
                body: JSON.stringify(data)
            });
            return response.json();
        }

        async function getData(url) {
            const response = await fetch(url, {
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Credentials': 'true'
                }
            });
            return response.json();
        }
    </script>
</body>

</html>