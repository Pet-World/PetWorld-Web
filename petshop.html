<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Bootstrap -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    <link rel="stylesheet" href="stylePetshop.css">
    <!-- <link rel="stylesheet" href="styleSoliCompra.css"> -->
    <link rel="stylesheet" href="estilos.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <title>PetShop</title>
</head>

<body>
    <header id="header">

        <nav class="navegacion" id="nav-menu-container">
            <div id="contenedor_logo">
                <img id="logo_img" src="img/logo.png" alt="logo" onclick="window.location.href='/PetWorld-Web/index.html'">

                <ul class="nav-menu">
                    <li><a href="index.html#hero">INICIO</a></li>
                    <li><a href="index.html#conocenos">CONÓCENOS</a></li>
                    <li><a href="index.html#servicios">SERVICIOS</a></li>
                    <li><a href="index.html#contact">CONTÁCTANOS</a></li>
                </ul>
            </div>
            <button id="btn_inisesion" onclick="window.location.href='/PetWorld-Web/inicioSesion.html'">INICIAR SESION</button>
        </nav>

    </header>
    <section id="noh">
        <rect></rect>
        <h1>Pet Shop</h1>
        <img class="bone" src="img/bone.png"></img>
        <t1>TOME EN CUENTA ACERCA DE</t1>
        <t2>LA COMPRA, ENTREGA Y PAGO</t2>
        <img class="icprod" src="img/prod.png"></img>
        <img class="bck" src="img/bckp.png"></img>
        <img class="pets" src="img/petss.png"></img>
        <p class="prn">
            Para llevar a su mascota a una consulta médica veterinaria, es necesario separar su cita, de acuerdo a la disponibilidad del Médico de turno, coordinando a través de nuestra central telefónica.<br><br> Recuerde que nuestro horario de atención
            de consultas inicia a las 09am. y culmina a las 20hrs. Siendo la última cita a las 19:30hrs.<br><br> Para que la atención de su mascota se desarrolle con tranquilidad y excelencia , le recomendamos asistir puntualmente al consultorio.<br><br>            En caso de no poder asistir a la consulta, lo recomendable es comunicarse a nuestra Central de Citas, llamando al 01 223-2180 y reprogramar la fecha y hora de su consulta.
        </p>
        <div class="filtro">
            <select name="cat" id="selCat" class="form-control"> 
            </select>
            <select name="brn" id="selBrand">
            </select>
            <input type="number" id="textPrice" placeholder="Precio máximo">
            <button name="btnSearch" id="btnSr" onclick="searchProduct()">Buscar</button>
        </div>
        <ord>
            <txfind>Resultados Encontrados</txfind>
            <div name="divResult" id="products">

            </div>

        </ord>
        <r2 data-toggle="modal" data-target="#myModal"></r2>
        <bt data-toggle="modal" data-target="#myModal">SOLICITAR</bt>
    </section>
    <div class="modal fade" id="myModal" role="dialog">
        <div id="contenedor-boleta">
            <div id="fila">
                <h2 id="titulo-boleta" style="margin-top: 0 !important;">Solicitud de Compra</h2>
                <button id="exit" data-dismiss="modal"><img src="img/exit.png" alt=""></button>
            </div>
            <div class="columna1">
                <div class="columna1" id="col1">
                    <fieldset>
                        <legend>Nombre(s)</legend>
                        <input readonly onmousedown="return false;" type="text" name="nombre" id="nombre">
                    </fieldset>

                    <!-- <fieldset>
                        <legend>DNI</legend>
                        <input readonly onmousedown="return false;" type="text" name="dni" id="dni">
                    </fieldset> -->

                    <fieldset>
                        <legend>Telefono Fijo</legend>
                        <input readonly onmousedown="return false;" type="text" name="fijo" id="fijo">
                    </fieldset>

                    <label for="delivery"><input type="checkbox" name="delivery" id="delivery">Delivery</label>

                    <fieldset>
                        <legend>Distrito</legend>
                        <select name="distrito" id="distrito">
                        <option value="Lima">Lima</option>
                    </select>
                    </fieldset>
                </div>
                <div class="columna2" id="col2">

                    <fieldset>
                        <legend>Apellido(s)</legend>
                        <input readonly onmousedown="return false;" type="text" name="apellidos" id="apellidos">
                    </fieldset>

                    <!-- Fieldset Telefono Invisible -->
                    <!-- <fieldset style="visibility: hidden;">
                        <legend>Telefono Movil</legend>
                        <input readonly onmousedown="return false;" type="text" name="movil" id="movil">
                    </fieldset> -->

                    <fieldset>
                        <legend>Telefono Movil</legend>
                        <input readonly onmousedown="return false;" type="text" name="movil" id="movil">
                    </fieldset>

                    <!-- Label Delivery Invisible -->
                    <label style="visibility: hidden;" for="delivery"><input type="checkbox" name="delivery" id="delivery">Delivery</label>

                    <fieldset>
                        <legend>Direccion</legend>
                        <input type="text" name="direccion" id="direccion">
                    </fieldset>
                </div>

                <!-- <fieldset class="fila2">
                <legend>Distrito</legend>
                <select name="distrito" id="distrito">
                    <option value="Lima">Lima</option>
                </select>
            </fieldset>
            <fieldset class="fila2">
                <legend>Direccion</legend>
                <input type="text" name="direccion" id="direccion">
            </fieldset> -->
                <fieldset class="cuadro-inline">
                    <legend>Sugerencia de fecha para el delivery</legend>
                    <input type="text" name="sugerencia" id="sugerencia">
                </fieldset>
            </div>
            <div class="columna2">
                <fieldset id="cuadro_resumen">
                    <legend>Resumen de solicitud de compra</legend>
                    <input type="text" name="resumen" id="resumen">
                </fieldset>
                <div class="text-input">
                    <input readonly onmousedown="return false;" type="number" name="total" id="total">
                    <h3>Total:</h3>
                </div>
                <div class="text-input" style="visibility: hidden;">
                    <input type="number" name="efectivo" id="efectivo">
                    <h3>Efectivo para pago:</h3>
                </div>
            </div>
            <p id="importante"><span>IMPORTANTE : </span>Tomar en cuenta las condiciones y pasos para la solicitud, entrega y pago de un servicio</p>
            <button id="enviar">ENVIAR</button>
        </div>
    </div>

    <script>
        var UrlBackendJS = "http://localhost:5000";

        var sel_categoria = document.getElementsByName("cat")[0];
        var sel_marca = document.getElementsByName("brn")[0];
        var divResult = document.getElementsByName("divResult")[0];

        var data;
        var dataFiltrada;
        var toShop = false;
        var shopList = new Map();

        async function makeShop(url, data = {}) {
            // Opciones por defecto estan marcadas con un *
            const response = await fetch(url, {
                method: 'POST',
                mode: 'cors',
                cache: 'no-cache',
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json'
                },
                redirect: 'follow',
                referrerPolicy: 'no-referrer',
                body: JSON.stringify(data)
            });
            return response.json(); // parses JSON response into native JavaScript objects
        }

        async function getData(url) {
            const response = await fetch(url, {
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Credentials': 'true'
                }
            });
            return response.json();
        }

        getData(UrlBackendJS + "/product/getProducts").then(response => {
                data = response.data;
                var categorias = [];
                var marcas = [];

                for (let i = 0; i < data.length; i++) {
                    shopList.set(data[i].id_producto, 0);
                    categorias.push(data[i].categoria);
                    marcas.push(data[i].marca);
                }

                var setCategorias = categorias.filter(function(item, pos, self) {
                    return self.indexOf(item) == pos;
                });
                var setMarcas = marcas.filter(function(item, pos, self) {
                    return self.indexOf(item) == pos;
                });



                for (let i = 0; i < setCategorias.length; i++) {
                    let option = document.createElement("option");
                    option.text = setCategorias[i];
                    sel_categoria.appendChild(option);
                }
                for (let i = 0; i < setMarcas.length; i++) {
                    let option = document.createElement("option");
                    option.text = setMarcas[i];
                    sel_marca.appendChild(option);
                }

            })
            .catch((error) => {
                console.log(error)
                console.log("ocurrio un error")
            });

        function searchProduct() {
            var opcionesSeleccionadas = [
                sel_categoria.options[sel_categoria.selectedIndex].text,
                sel_marca.options[sel_marca.selectedIndex].text,
                document.getElementById("textPrice").value == "" ? 1000 : document.getElementById("textPrice").value
            ];

            dataFiltrada = data.filter(function(el) {
                return el.categoria == opcionesSeleccionadas[0] &&
                    el.marca == opcionesSeleccionadas[1] &&
                    el.precio <= opcionesSeleccionadas[2];
            });

            // eliminamos los hijos antes existentes
            let len = divResult.childElementCount;
            let child = divResult.lastElementChild;
            while (child && len >= 1) {
                divResult.removeChild(child);
                len -= 1;
                child = divResult.lastElementChild;
            }

            if (dataFiltrada.length == 0) {

                let div = document.createElement("div");
                let h3 = document.createElement("h3");
                h3.innerHTML = "NO SE ENCONTRARON ELEMENTOS";
                div.appendChild(h3);
                divResult.appendChild(div);
            } else {
                for (let i = 0; i < dataFiltrada.length; i++) {

                    // aqui recien agregamos los nuevos hijos
                    const element = dataFiltrada[i];
                    let divProduct = document.createElement("div");
                    let divPrDesc = document.createElement("div");
                    let img = document.createElement("img");
                    let precio = document.createElement("span");
                    let nombre = document.createElement("span");
                    let marca = document.createElement("span");
                    let menos = document.createElement("menos");
                    let mas = document.createElement("mas");
                    let recnt = document.createElement("recnt");

                    divProduct.className = "product";
                    divPrDesc.className = "prDesc";
                    precio.innerHTML = "S/." + element.precio;
                    precio.className = "prPrice";
                    nombre.innerHTML = element.nombre;
                    nombre.className = "prName";
                    marca.innerHTML = element.marca;
                    marca.className = "prBrand";
                    img.src = "img/pets1.png";
                    img.alt = "";
                    img.className = "productImg";

                    mas.addEventListener("click", function() {
                        addProduct(element)
                        updCont(element, recnt)
                    });

                    menos.addEventListener("click", function() {
                        rmvProduct(element)
                        updCont(element, recnt)
                    });
                    divPrDesc.appendChild(precio);
                    divPrDesc.appendChild(nombre);
                    divPrDesc.appendChild(marca);

                    divProduct.appendChild(img);
                    divProduct.appendChild(divPrDesc);
                    divProduct.appendChild(menos);
                    divProduct.appendChild(recnt);
                    divProduct.appendChild(mas);

                    divResult.appendChild(divProduct);

                }
            }
        }

        function updCont(prd, elCont) {
            var id = shopList.get(prd.id_producto)
            elCont.innerHTML = id
        }

        function addProduct(productDataToAdd) {
            console.log("Producto agregado!");
            console.log(productDataToAdd)
            var n = shopList.get(productDataToAdd.id_producto)
            shopList.set(productDataToAdd.id_producto, n + 1)

        }

        function rmvProduct(productDataToRmv) {
            console.log("Producto removido!");
            var n = shopList.get(productDataToRmv.id_producto)
            if (n > 0) {
                shopList.set(productDataToRmv.id_producto, n - 1);
            }
        }

        var btn = document.getElementsByTagName("r2")[0];
        btn.addEventListener("click", function() {
            for (let i = 0; i < data.length; i++) {
                var n = shopList.get(data[i].id_producto);
                if (n > 0) {
                    var fs = document.getElementById("cuadro_resumen");
                    fs.innerHTML = n;
                    console.log(n);
                }
            }
            /* makeShop(UrlBackendJS + '', { data: productDataToShop })
                .then(response=> {
                    console.log(response); // JSON data parsed by `data.json()` call
                }) */
        });
        var btn2 = document.getElementsByTagName("bt")[0];
        btn2.addEventListener("click", function() {
            for (let i = 0; i < data.length; i++) {
                var n = shopList.get(data[i].id_producto);
                if (n > 0) {
                    var fs = document.getElementsById("cuadro_resumen");
                    fs.innerHTML = n;
                    console.log(n);
                }
            }
            /* makeShop(UrlBackendJS + '', { data: productDataToShop })
                .then(response=> {
                    console.log(response); // JSON data parsed by `data.json()` call
                }) */
        });
    </script>
</body>

</html>